# PowerPing UPS断电保护程序
适用只有停电切换供电功能，没办法发送断电指令的**丐版UPS（山克 k2000等）**

查看网上只有简单bash监控脚本，没办法满足稍微复杂一些的判定逻辑

通过监控内网多个设备IP在线情况判断是否断电，如判定断电后则启动关机任务

1. 支持多个IP轮询判定，如所有设备均不能访问则判定断电状态
2. 支持ssh关机

### 运行逻辑：

```text
监控（ping）-> IP1（Flase）

				   ->IP2（Flase）

						->IP3（Flase）

							->Sleep 5m [等待来电]

									->PING（Flase）

											    ->ssh批量关机
															-> 关闭本机

									->PING（True）[供电恢复]

											 -> 重启循环

			-> IP1（True）

				    -> Sleep 30s [30s后监控]
```

### 参数：

```bash
ping_params:
    interval_time: 5s # 监控循环间隔
    retry_count: 1    # 失败重试次数
    timeout: 1s       # 每次ping超时时间
    target_ips:       # 监控主机目标，建议 互联网IP，网关IP，物联网设备IP顺序
        - 8.8.8.9
wait_time: 5m         # 判定断电后等待时间
host_params:          # 目标的ssh信息
    - host: 192.168.1.1
      port: 22
      hostname: centos7
      username: root
      password: password

```


### 使用说明：

第一次启动会生成自动生成`config.yml`配置文件,按需编辑配置后，启动程序.

**注意:** 需要判定关机顺序,如PVE,ESXI等虚拟化平台,**母机作为监控机**,保证母机最后关机


### 执行过程日志示例:
```bash
2023/11/19 20:06:57 尝试 Ping IP: 8.8.8.9，失败次数: 1
2023/11/19 20:06:58 尝试 Ping IP: 10.10.10.1，失败次数: 1
2023/11/19 20:06:58 所有IP无法Ping通,疑似断电,等待5s后关机...
2023/11/19 20:07:03 关机前重新检测是否电力恢复.
2023/11/19 20:07:04 尝试 Ping IP: 8.8.8.9，失败次数: 1
2023/11/19 20:07:05 尝试 Ping IP: 10.10.10.1，失败次数: 1
2023/11/19 20:07:05 电力未恢复,开始关机
2023/11/19 20:07:05 在 192.168.242.133:22 上执行命令成功,3秒后关机
2023/11/19 20:07:05 本机关机
```